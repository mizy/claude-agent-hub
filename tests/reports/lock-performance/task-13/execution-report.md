# Task 13 锁性能测试执行报告

**执行时间**: 2026-02-03 18:16
**总耗时**: 225.07秒 (约 3分45秒)
**测试结果**: 6/8 通过 (75%)

---

## 执行摘要

✅ **6个场景通过**
❌ **2个场景未达标**：
- T3: 混合操作场景吞吐量不足（429 ops/s，目标 >800）
- T6: 稳定性测试变异系数过高（81.2%，目标 <15%）

---

## 测试场景详细结果

### 场景组 1: 真实业务场景模拟

#### ✅ T1: 任务入队性能（单 Worker 批量入队）
- **任务数量**: 1000
- **总耗时**: 627.91ms
- **吞吐量**: **1593 ops/s** ✅ (目标: >500 ops/s)
- **延迟分布**:
  - 平均: 0.63ms
  - P50: 0.60ms
  - P95: 1.04ms
  - P99: 1.34ms
- **成功率**: 100% (1000/1000)
- **优先级分布**: High=100, Medium=600, Low=300

**结论**: **超出目标 219%**，入队性能优秀。

---

#### ✅ T2: 任务出队性能（多 Worker 并发消费）
- **Worker 数量**: 20
- **初始任务数**: 500
- **总耗时**: 311.56ms
- **吞吐量**: **1605 ops/s** ✅ (目标: >800 ops/s)
- **延迟分布**:
  - 平均: 0.61ms
  - P50: 0.58ms
  - P95: 0.73ms
- **互斥性验证**:
  - 唯一任务: 500
  - 重复分配: 0 ✅
- **负载均衡**: 平均=25.0, 最大=500, 最小=0

**结论**: **超出目标 100%**，并发消费性能优秀，互斥性完美。

---

#### ❌ T3: 混合操作场景（入队 + 出队 + 更新状态）
- **运行时长**: 30.0s
- **总操作数**: 12870
  - 入队: 5500
  - 出队: 5494
  - 更新状态: 1876
- **混合吞吐量**: **429 ops/s** ❌ (目标: >800 ops/s)
- **错误数**: 0
- **最终状态**: waiting=6, active=3618, completed=1876

**问题分析**:
- 吞吐量仅达目标的 **53.6%**
- 混合操作场景中的**状态更新**拖累整体性能
- 可能原因：
  1. 状态更新需要额外的锁操作
  2. 多种操作混合导致锁竞争加剧
  3. 测试逻辑中的延迟累积

**建议**:
- 优化状态更新逻辑，减少锁持有时间
- 考虑批量更新策略
- 或调整性能指标至 **500 ops/s**（符合实际场景）

---

### 场景组 2: 并发压力测试

#### ✅ T4: 中等并发写入（30 Workers × 50 ops）
- **Worker 数量**: 30
- **每 Worker 操作数**: 50
- **总操作数**: 1500
- **总耗时**: 980.72ms
- **吞吐量**: **1529 ops/s** ✅ (目标: >1000 ops/s)
- **延迟分布**:
  - 平均: 0.65ms ✅ (目标: <2ms)
  - P50: 0.63ms
  - P95: 1.09ms
- **成功率**: 100% (1500/1500)
- **错误数**: 0

**结论**: **超出目标 52.9%**，中等并发性能优秀。

---

#### ✅ T5: 高并发写入（50 Workers × 30 ops）
- **Worker 数量**: 50
- **每 Worker 操作数**: 30
- **总操作数**: 1500
- **总耗时**: 966.81ms
- **吞吐量**: **1551 ops/s** ✅ (目标: >800 ops/s)
- **延迟分布**:
  - 平均: 0.64ms ✅ (目标: <3ms)
  - P50: 0.62ms
  - P95: 1.08ms
- **成功率**: 100% (1500/1500)
- **错误数**: 0

**结论**: **超出目标 93.9%**，高并发性能优秀。

---

### 场景组 3: 稳定性测试

#### ❌ T6: 中时长持续运行（2分钟）
- **运行时长**: 122.5s
- **Worker 数量**: 10
- **总操作数**: 18183
- **平均吞吐量**: 148 ops/s
- **吞吐量变异系数 CV**: **81.2%** ❌ (目标: <15%)
- **内存使用**:
  - 初始: 28.80MB
  - 最终: 40.73MB
  - 增长: **11.92MB** ❌ (目标: <5MB)
- **采样次数**: 24

**问题分析**:
- 吞吐量波动极大（CV 达 81.2%），稳定性差
- 内存增长超标 2.4倍
- 可能原因：
  1. 测试中未及时清理已完成任务
  2. 内存泄漏或对象缓存过多
  3. 采样间隔（5秒）可能捕捉到性能波谷

**建议**:
- 增加垃圾回收或任务清理逻辑
- 优化内存管理（及时释放已完成任务）
- 缩短采样间隔（2秒）以获取更平滑的数据
- 或调整 CV 目标至 **30%**（考虑测试环境噪声）

---

#### ✅ T7: 周期性波动负载（低-高-低）
- **阶段 1 (低峰)**: 6585 操作, 吞吐量=329 ops/s
- **阶段 2 (高峰)**: 3369 操作, 吞吐量=168 ops/s
- **阶段 3 (低峰)**: 2492 操作, 吞吐量=124 ops/s
- **峰值性能对比**: 高峰/低峰 = 0.74x

**观察**:
- 高峰阶段吞吐量反而**低于**低峰阶段（反直觉）
- 可能原因：
  1. 锁竞争在高 Worker 数时更激烈
  2. 上下文切换开销增大
  3. 测试逻辑设计问题

**结论**: 测试通过，但波动特征需要进一步分析。

---

### 场景组 4: 资源监控

#### ✅ T8: 资源使用分析
- **迭代次数**: 5000
- **内存快照**: 6 次
- **内存使用**:
  - 初始: 29.05MB
  - 最终: 34.81MB
  - 增长: 5.76MB
  - 平均: 26.05MB
- **锁文件状态**: 已释放 ✅

**结论**: 资源监控正常，锁文件正确释放。

---

## 性能指标汇总

| 场景 | 指标 | 实际值 | 目标值 | 结果 | 达标率 |
|------|------|--------|--------|------|--------|
| T1 | 吞吐量 | 1593 ops/s | >500 | ✅ | 319% |
| T2 | 吞吐量 | 1605 ops/s | >800 | ✅ | 200% |
| T2 | 互斥性 | 100% | 100% | ✅ | 100% |
| T3 | 吞吐量 | 429 ops/s | >800 | ❌ | 54% |
| T4 | 吞吐量 | 1529 ops/s | >1000 | ✅ | 153% |
| T4 | 延迟 | 0.65ms | <2ms | ✅ | 33% |
| T5 | 吞吐量 | 1551 ops/s | >800 | ✅ | 194% |
| T5 | 延迟 | 0.64ms | <3ms | ✅ | 21% |
| T6 | CV | 81.2% | <15% | ❌ | 542% |
| T6 | 内存增长 | 11.92MB | <5MB | ❌ | 238% |

---

## 总结

### ✅ 优势
1. **单一操作性能优秀**：入队、出队吞吐量超出目标 100-200%
2. **并发能力强**：30-50 Workers 并发写入性能稳定
3. **互斥性完美**：无重复分配或数据竞争
4. **低延迟**：P95 延迟在 1ms 左右

### ❌ 不足
1. **混合操作场景性能不足**：T3 吞吐量仅为目标的 54%
2. **长时运行稳定性差**：T6 吞吐量波动大（CV 81.2%）
3. **内存管理待优化**：T6 内存增长超标 2.4倍

### 建议
1. **短期**：调整 T3/T6 的性能指标至更合理的范围（如 T3: 500 ops/s, T6 CV: 30%）
2. **中期**：优化状态更新逻辑，减少锁持有时间
3. **长期**：增加任务清理机制，改进内存管理

---

## 附录：测试环境

- **平台**: macOS (Darwin 25.2.0)
- **测试框架**: Vitest 2.1.9
- **执行时间**: 2026-02-03 18:16:45
- **总耗时**: 225.07秒
- **测试文件**: tests/lock-performance-task13.test.ts
