# 锁性能测试任务 12 - 测试计划

**任务目标**: 性能退化专项调查
**执行日期**: 2026年02月03日
**执行人**: Pragmatist
**预计耗时**: ~25 分钟

---

## 核心问题

🎯 **主要调查目标**: 并发性能退化 17.5%（1.48ms vs 1.26ms）

**需要回答的关键问题**:
1. 并发性能退化是否稳定存在？
2. 退化的根本原因是什么？
3. 退化是代码变更还是环境因素引起？
4. 如何优化以恢复或超越基线性能？

---

## 测试场景清单

### 场景组 1: 基线重复测试（10 次迭代）

| ID | 测试场景 | 配置 | 目标 |
|----|---------|------|------|
| T1 | 单次锁操作延迟稳定性 | 10 次 × 1000 次迭代 | 确认退化是否稳定 |
| T2 | 并发竞争延迟稳定性 | 10 次 × 10 workers × 100 次 | 重点关注 1.48ms vs 1.26ms |
| T3 | 吞吐量稳定性 | 10 次 × 10000 次压力测试 | 计算变异系数 |

### 场景组 2: 并发性能深度分析

| ID | 测试场景 | 变量 | 目标 |
|----|---------|------|------|
| T4 | 不同竞争者数量下的性能 | 2/5/10/20/50 个竞争者 | 识别扩展性瓶颈 |
| T5 | 不同持有锁时间的影响 | 0ms/10ms/50ms/100ms | 分析锁持有时间影响 |
| T6 | 重试机制性能分析 | 重试次数 vs 延迟 | 优化重试策略 |

### 场景组 3: 系统负载影响测试

| ID | 测试场景 | 配置 | 目标 |
|----|---------|------|------|
| T7 | 空闲系统性能 | CPU < 10% | 建立纯净基线 |
| T8 | 中等负载性能 | CPU ~50% | 评估典型负载影响 |
| T9 | 高负载性能 | CPU ~80% | 评估极端负载影响 |

### 场景组 4: 文件 I/O 性能分析

| ID | 测试场景 | 工具 | 目标 |
|----|---------|------|------|
| T10 | 锁操作分段计时 | perf_hooks | 量化 I/O 占比 |
| T11 | 文件系统调用统计 | 调用计数 | 识别高频操作 |

**总计**: 11 个测试场景

---

## 测试参数

### 重复测试配置
```typescript
{
  iterations: 10,        // 重复测试次数
  warmupRuns: 2,         // 预热次数
  cooldownMs: 5000,      // 测试间冷却时间
}
```

### 并发测试配置
```typescript
{
  workers: [2, 5, 10, 20, 50],      // 竞争者数量
  lockHoldTime: [0, 10, 50, 100],   // 持有锁时间（毫秒）
  operationsPerWorker: 100,         // 每个 worker 的操作次数
}
```

---

## 性能指标

### 核心指标

| 指标 | 目标值 | 基线值 | 当前值 | 变化 |
|------|--------|--------|--------|------|
| 单次锁操作延迟 | < 1ms | 0.102ms | 0.106ms | +3.9% |
| 锁检查延迟 | < 0.1ms | 0.001ms | 0.001ms | ±0% |
| 高频吞吐量 | > 1K ops/s | 10,075 ops/s | 9,713 ops/s | -3.6% |
| **并发竞争延迟** | **< 2.5ms** | **1.26ms** | **1.48ms** | **+17.5% ⚠️** |
| 并发互斥性 | 100% | 100% | 100% | - |
| 错误率 | < 1% | 0% | 0% | - |

### 扩展指标（新增）

| 指标 | 测量方法 |
|------|---------|
| 性能稳定性（CV） | 标准差 / 平均值 < 10% |
| P50/P75/P90/P95/P99 延迟 | 分位数统计 |
| 文件 I/O 占比 | perf_hooks 分段计时 |
| 并发扩展性 | 不同竞争者数量下的性能曲线 |
| 系统负载影响 | 不同负载下的性能差异 < 20% |

---

## 数据收集

### 统计指标
- 平均值 (mean)
- 标准差 (stdDev)
- 变异系数 (CV = stdDev / mean)
- 95% 置信区间 (CI95)
- 分位数 (P50/P75/P90/P95/P99)

### 对比分析
- 当前值 vs 基线值
- 变化百分比
- 是否显著退化
- 退化严重程度（low/medium/high）

---

## 预期产出

### 文档
- ✅ `requirements-analysis.md` - 需求分析报告
- ✅ `TEST_PLAN.md` - 测试计划（本文件）
- 🔄 `test-execution-report.md` - 测试执行报告
- 🔄 `performance-analysis.md` - 性能分析报告
- 🔄 `regression-investigation.md` - 性能退化调查报告
- 🔄 `optimization-recommendations.md` - 优化建议报告
- 🔄 `final-report.md` - 最终总结报告

### 数据
- 🔄 `performance-data.json` - 原始性能数据
- 🔄 `statistics-summary.json` - 统计摘要
- 🔄 `comparison-chart.md` - 性能对比图表

---

## 实施步骤

| 步骤 | 任务 | 预计耗时 | 状态 |
|------|------|---------|------|
| 1 | 环境准备 | 2 分钟 | 🔄 待执行 |
| 2 | 实现测试代码 | 10 分钟 | 🔄 待执行 |
| 3 | 执行测试 | 3 分钟 | 🔄 待执行 |
| 4 | 数据分析 | 5 分钟 | 🔄 待执行 |
| 5 | 生成报告 | 5 分钟 | 🔄 待执行 |
| **总计** | | **25 分钟** | |

---

## 成功标准

### 测试成功
- ✅ 所有 11 个测试场景执行完成
- ✅ 数据收集完整（10 次重复 × 6 个核心指标）
- ✅ 统计分析有效（置信区间、变异系数、分位数）
- ✅ 回答关键问题（性能退化原因、优化建议）

### 报告完整
- ✅ 包含原始数据和统计摘要
- ✅ 包含性能对比图表
- ✅ 包含明确的结论和建议
- ✅ 可操作性强（具体优化步骤）

---

## 风险与缓解

| 风险 | 影响 | 缓解措施 |
|------|------|---------|
| 系统后台进程干扰 | 性能数据不稳定 | 测试前关闭不必要应用 |
| 测试耗时过长 | 影响整体进度 | 限制重复次数为 10 次 |
| 统计样本不足 | 置信度低 | 记录样本量和置信区间 |
| 临时文件残留 | 影响后续测试 | 每次测试后完全清理 |

---

## 参考资料

### 历史报告
- `tests/reports/lock-performance/FINAL_REPORT.md` - 任务 19 最终报告
- `tests/reports/lock-performance/README.md` - 主索引
- `tests/reports/lock-performance/baseline-20260203.json` - 性能基线

### 测试文件
- `tests/lock-performance.test.ts` - 基础测试（10 个场景）
- `tests/lock-performance-task18.test.ts` - WorkflowQueue 测试（12 个场景）
- `tests/lock-performance-task15.test.ts` - 轻量级测试（6 个场景）

### 实现代码
- `src/workflow/queue/WorkflowQueue.ts:37-96` - WorkflowQueue 锁实现

---

**计划状态**: ✅ 完成
**下一步**: 准备测试环境
**文档版本**: v1.0
**生成时间**: 2026-02-03 17:48
