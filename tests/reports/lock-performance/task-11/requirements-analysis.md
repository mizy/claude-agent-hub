# 锁性能测试任务 11 - 需求分析报告

**任务编号**: 11
**任务标题**: 锁性能测试-11
**分析日期**: 2026年02月03日 18:15
**分析人**: Pragmatist

---

## 1. 任务目标

基于历史任务分析，任务 11 的目标是继续完善锁性能测试体系，重点关注：

### 1.1 核心目标
1. **验证基础锁性能指标** - 确保锁机制满足生产环境要求
2. **建立性能基线数据** - 为后续性能对比提供参考
3. **识别性能瓶颈** - 找出可优化的关键路径
4. **生成完整测试报告** - 记录测试结果和分析结论

### 1.2 测试范围
- WorkflowQueue 队列锁机制 (`queue.json.lock`)
- Runner 进程锁机制 (`runner.lock`)
- 基本性能、并发安全、压力测试、可靠性四大维度

---

## 2. 历史测试回顾

### 2.1 已完成的相关任务

| 任务 | 日期 | 重点关注 | 核心发现 | 状态 |
|------|------|---------|---------|------|
| **Task-19** | 2026-02-03 | 基础性能基线建立 | 建立完整性能基线 | ✅ 完成 |
| **Task-18** | 2026-02-03 | WorkflowQueue 真实锁机制 | 12 个场景深度测试 | ✅ 完成 |
| **Task-17** | 2026-02-03 | 稳定性验证 | - | ✅ 完成 |
| **Task-16** | 2026-02-03 | 性能验证 | 发现并发退化 17.5% | ⚠️ 需验证 |
| **Task-15** | 2026-02-03 | 轻量级验证 | - | ✅ 完成 |
| **Task-14** | 2026-02-03 | 特定场景测试 | - | ✅ 完成 |
| **Task-12** | 2026-02-03 | 退化问题专项调查 | 证明退化不存在 | ✅ 完成 |

### 2.2 Task-19 性能基线（参考标准）

| 指标 | 基线值 | 目标阈值 | 重要性 |
|------|--------|---------|--------|
| 单次锁操作延迟 | 0.102ms | < 1ms | ⭐⭐⭐ |
| 锁检查延迟 | 0.001ms | < 0.1ms | ⭐⭐⭐ |
| PID 读取延迟 | 0.013ms | < 0.2ms | ⭐⭐ |
| 高频吞吐量 | 10,075 ops/s | > 1,000 ops/s | ⭐⭐⭐ |
| 并发竞争延迟 | 1.260ms | < 2.5ms | ⭐⭐⭐ |
| 并发互斥正确性 | 100% | 100% | ⭐⭐⭐ |
| 错误率 | 0% | < 1% | ⭐⭐⭐ |

### 2.3 Task-12 关键发现

- ✅ **并发性能正常**：0.954ms（优于基准 24.3%）
- ⚠️ **稳定性需改进**：CV 24-32%（预期 <15%）
- 📊 **性能瓶颈**：文件写入占 62.8% 时间
- 🎯 **最佳并发度**：5 Workers

---

## 3. 任务 11 的测试场景

### 3.1 必须测试的场景（基础）

#### 场景组 1: 基本性能测试（3 个）

| ID | 场景 | 测试方法 | 目标指标 | 优先级 |
|----|------|---------|---------|--------|
| T1 | 单次锁操作性能 | 1,000 次迭代 | < 1ms | P0 |
| T2 | 锁检查性能 | 10,000 次迭代 | < 0.1ms | P0 |
| T3 | PID 读取性能 | 5,000 次迭代 | < 0.2ms | P1 |

#### 场景组 2: 并发安全测试（2 个）

| ID | 场景 | 测试方法 | 目标指标 | 优先级 |
|----|------|---------|---------|--------|
| T4 | 并发写入竞争 | 10 workers × 100 次 | 100% 互斥 | P0 |
| T5 | 死锁检测与清理 | 模拟死进程 | < 10ms | P0 |

#### 场景组 3: 压力测试（2 个）

| ID | 场景 | 测试方法 | 目标指标 | 优先级 |
|----|------|---------|---------|--------|
| T6 | 高频率锁操作 | 10,000 次迭代 | > 1,000 ops/s | P0 |
| T7 | 长时间持有锁影响 | 100ms 持有 + 1,000 次检查 | 正常排队 | P1 |

#### 场景组 4: 可靠性测试（3 个）

| ID | 场景 | 测试方法 | 预期结果 | 优先级 |
|----|------|---------|---------|--------|
| T8 | 锁状态一致性 | 获取/释放/重复释放 | 状态正确 | P0 |
| T9 | 锁文件损坏处理 | 写入无效内容 | 自动恢复 | P1 |
| T10 | 锁被外部删除 | 直接删除锁文件 | 自动恢复 | P1 |

**总计**: 10 个基础测试场景

### 3.2 推荐的补充场景（可选）

#### 场景组 5: 性能分析（可选）

| ID | 场景 | 测试方法 | 分析重点 | 优先级 |
|----|------|---------|---------|--------|
| T11 | 不同竞争者数量 | 1/2/5/10/20 workers | 最佳并发度 | P2 |
| T12 | 锁操作分段计时 | 检查/创建/释放分别计时 | 识别瓶颈 | P2 |
| T13 | 文件系统调用统计 | 统计每次锁的 I/O 次数 | 优化方向 | P2 |

---

## 4. 测试代码结构

### 4.1 可复用的测试文件

| 文件 | 覆盖场景 | 代码量 | 推荐使用 |
|------|---------|--------|---------|
| `lock-performance.test.ts` | T1-T10（基础 10 个） | 346 行 | ⭐⭐⭐ 推荐 |
| `lock-performance-task18.test.ts` | WorkflowQueue 专项 12 个 | 774 行 | ⭐⭐ 深度测试用 |
| `lock-performance-task12.test.ts` | 退化调查 11 个 | 22,823 字节 | ⭐⭐ 稳定性分析用 |

### 4.2 锁机制实现位置

**WorkflowQueue 锁** (`src/workflow/queue/WorkflowQueue.ts:37-96`):
```typescript
// 关键特性：
// - 文件系统锁（writeFileSync with flag: 'wx'）
// - 30 秒超时机制（防止死锁）
// - 重试机制（最多 10 次，每次 100ms）
// - 支持进程 PID 记录
```

---

## 5. 任务 11 实施方案

### 5.1 推荐方案：基础验证 + 快速报告

**理由**:
1. Task-19 已建立完整基线
2. Task-12 已验证并发性能正常
3. 任务 11 重点在于验证稳定性和生成报告
4. 避免重复劳动，专注增量价值

**实施步骤**:
1. ✅ **需求分析**（当前节点）- 完成
2. 🔄 **准备测试环境** - 验证依赖、清理临时文件
3. 🔄 **执行基础测试** - 运行 `lock-performance.test.ts`（10 个场景）
4. 🔄 **收集性能数据** - 记录所有关键指标
5. 🔄 **基线对比分析** - 与 Task-19 基线对比
6. 🔄 **生成测试报告** - 创建任务 11 专属报告

### 5.2 预期产出

**文档产出**:
- ✅ `requirements-analysis.md` - 需求分析报告（本文件）
- 🔄 `env-status.md` - 环境状态报告
- 🔄 `test-execution-report.md` - 测试执行报告
- 🔄 `performance-data.json` - 性能数据（JSON 格式）
- 🔄 `comparison-analysis.md` - 基线对比分析
- 🔄 `final-report.md` - 最终总结报告
- 🔄 `README.md` - 导航索引

**数据产出**:
- 10 个测试场景的详细性能数据
- 与 Task-19 基线的对比结果
- 性能趋势分析（如有退化则标注）
- 优化建议清单

### 5.3 预期时间

| 阶段 | 预计时间 |
|------|---------|
| 环境准备 | ~1 分钟 |
| 测试执行 | ~1-2 分钟 |
| 数据收集 | ~1 分钟 |
| 分析报告 | ~2-3 分钟 |
| **总计** | **~5-7 分钟** |

---

## 6. 关键性能指标定义

### 6.1 核心指标

| 指标 | 定义 | 计算方法 | 告警阈值 |
|------|------|---------|---------|
| **单次锁延迟** | 单次获取+释放锁的耗时 | P50/P95/P99 分位数 | P95 > 1ms |
| **锁检查延迟** | 检查锁状态的耗时 | 平均值 | > 0.1ms |
| **吞吐量** | 每秒可完成的锁操作数 | ops/s | < 1,000 ops/s |
| **并发互斥性** | 并发场景下的数据一致性 | 成功率 % | < 100% |
| **错误率** | 锁操作失败的比例 | 失败次数 / 总次数 | > 1% |

### 6.2 扩展指标

| 指标 | 用途 | 优先级 |
|------|------|--------|
| **变异系数 (CV)** | 评估稳定性 | P1 |
| **P50/P95/P99 延迟** | 评估尾延迟 | P0 |
| **最佳并发度** | 优化并发配置 | P2 |
| **I/O 占比** | 识别瓶颈 | P2 |

---

## 7. 风险与限制

### 7.1 已知限制

1. **文件系统依赖** - 性能受文件系统类型影响
   - macOS APFS：高性能
   - 网络文件系统：性能不可控

2. **并发度限制** - 竞争者数量 > 20 时开销显著（Task-19 已识别）

3. **测试环境差异** - 系统负载、缓存状态影响结果

### 7.2 缓解措施

- ✅ 使用独立临时目录（带时间戳）
- ✅ 测试前清理缓存（`sudo purge`）
- ✅ 测试后自动清理（afterEach 钩子）
- ✅ 设置合理超时时间
- ✅ 记录测试环境信息

---

## 8. 参考资料

### 8.1 相关文件路径

**测试文件**:
- `tests/lock-performance.test.ts` - 基础 10 场景
- `tests/lock-performance-task18.test.ts` - WorkflowQueue 专项
- `tests/lock-performance-task12.test.ts` - 退化调查

**锁机制实现**:
- `src/workflow/queue/WorkflowQueue.ts:37-96` - 锁实现
- `src/store/paths.ts` - 锁文件路径定义

**历史报告**:
- `tests/reports/lock-performance/FINAL_REPORT.md` - Task-19 完整报告
- `tests/reports/lock-performance/baseline-20260203.json` - 性能基线
- `tests/reports/lock-performance/task-12/README.md` - Task-12 退化调查
- `tests/reports/lock-performance/task-16-requirements.md` - Task-16 需求分析

### 8.2 测试环境要求

**依赖项**:
- Node.js: v20+
- Vitest: ^2.1.9
- TypeScript: ^5.7.3

**系统要求**:
- macOS Darwin 25.2.0（当前环境）
- 临时目录：`/tmp/cah-lock-test-*`
- 磁盘空间：> 100MB

---

## 9. 下一步行动

### 9.1 当前节点完成标志

✅ **已完成**:
- 分析任务 11 的具体要求
- 查看项目中已有的锁性能测试相关文件
- 了解测试模式和要求
- 识别 10 个必测场景 + 3 个可选场景
- 参考历史测试报告（Task-19/12/16）

### 9.2 输出总结

**(1) 任务 11 的具体测试目标**:
- 验证基础锁性能指标（10 个场景）
- 与 Task-19 基线对比
- 确认无性能退化
- 生成完整测试报告

**(2) 需要测试的场景**:
- 基本性能：T1-T3（单次锁、锁检查、PID 读取）
- 并发安全：T4-T5（并发竞争、死锁清理）
- 压力测试：T6-T7（高频操作、长时间持有）
- 可靠性：T8-T10（状态一致性、损坏处理、删除恢复）

**(3) 参考的历史测试报告**:
- Task-19：`FINAL_REPORT.md` + `baseline-20260203.json`
- Task-12：`task-12/README.md` + `task-12/test-report.md`
- Task-16：`task-16-requirements.md`

### 9.3 为下一节点准备的信息

**下一节点**: 准备测试环境

**需要执行的操作**:
1. 验证测试依赖（Vitest、TypeScript）
2. 清理旧的测试数据和临时文件
3. 创建任务 11 的报告目录结构
4. 确认测试文件可执行
5. 生成环境状态报告 `env-status.md`

**关键决策**:
- ✅ 使用 `lock-performance.test.ts`（基础 10 场景）
- ✅ 不需要实现新的测试场景
- ✅ 重点在数据收集和基线对比

---

**文档状态**: ✅ 完成
**下一节点**: 准备测试环境
**负责人**: Pragmatist
**生成时间**: 2026-02-03 18:15
